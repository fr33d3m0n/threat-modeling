# Data Model Contract
# Version: 3.0.0
# Purpose: Define all entity schemas and relationships for STRIDE threat modeling

---

# =============================================================================
# Finding Entity (P1-P4)
# =============================================================================
Finding:
  description: "Security-related observation, defect, or risk point from phases 1-4"
  id:
    format: "F-P{N}-{Seq:03d}"
    examples:
      - "F-P1-001"
      - "F-P2-005"
      - "F-P4-003"
  fields:
    id:
      type: string
      required: true
    phase:
      type: integer
      enum: [1, 2, 3, 4]
      required: true
    title:
      type: string
      required: true
    description:
      type: string
      required: true
    severity:
      type: string
      enum: [CRITICAL, HIGH, MEDIUM, LOW, INFO]
      required: true
    location:
      type: object
      properties:
        file:
          type: string
        line:
          type: integer
        element_id:
          type: string
    created_at:
      type: datetime
      required: true

# =============================================================================
# DFD Elements (P2)
# =============================================================================
ExternalInteractor:
  id:
    format: "EI-{NNN}"
    example: "EI-001"
  fields:
    id:
      type: string
      required: true
    name:
      type: string
      required: true
    type:
      type: string
      enum: [Human, InternalService, ExternalSystem]
      required: true
    interacts_with:
      type: array
      items: string

Process:
  id:
    format: "P-{NNN}"
    example: "P-001"
  fields:
    id:
      type: string
      required: true
    name:
      type: string
      required: true
    maps_to_module:
      type: string
      description: "Link to P1 module M-xxx"
    auth_required:
      type: boolean
    entry_points:
      type: array
      items: string

DataStore:
  id:
    format: "DS-{NNN}"
    example: "DS-001"
  fields:
    id:
      type: string
      required: true
    name:
      type: string
      required: true
    type:
      type: string
      examples: [PostgreSQL, MongoDB, Redis, S3]
    sensitivity:
      type: string
      enum: [CRITICAL, HIGH, MEDIUM, LOW]
      required: true
    stores:
      type: array
      items: string
      description: "Data types stored"
    encryption:
      type: object
      properties:
        at_rest:
          type: boolean
        in_transit:
          type: boolean

DataFlow:
  id:
    format: "DF-{NNN}"
    example: "DF-001"
  fields:
    id:
      type: string
      required: true
    from:
      type: string
      description: "Source element ID (EI/P/DS)"
      required: true
    to:
      type: string
      description: "Target element ID (EI/P/DS)"
      required: true
    data:
      type: string
      description: "Data being transferred"
      required: true
    protocol:
      type: string
      examples: [HTTPS, gRPC, TCP, Internal]
    encrypted:
      type: boolean

TrustBoundary:
  id:
    format: "TB-{NNN}"
    example: "TB-001"
  fields:
    id:
      type: string
      required: true
    name:
      type: string
      required: true
    type:
      type: string
      enum: [Network, Process, User, Data, Service]
      required: true
    description:
      type: string
      description: "Description of the boundary and its purpose"
    inside:
      type: array
      items: string
      description: "Element IDs inside boundary"
    outside:
      type: array
      items: string
      description: "Element IDs outside boundary"
    crossing_points:
      type: array
      items:
        type: object
        properties:
          flow_id:
            type: string
            description: "DF-xxx data flow crossing this boundary"
          direction:
            type: string
            enum: [inbound, outbound, bidirectional]
          controls:
            type: array
            items: string
            description: "Security controls at crossing (e.g., TLS, WAF)"
      description: "Data flows crossing this boundary"

# =============================================================================
# Threat Entity (P5)
# =============================================================================
Threat:
  description: "Potential attack vector identified through STRIDE analysis"
  id:
    format: "T-{STRIDE}-{ElementID}-{Seq}"
    examples:
      - "T-S-P-001-001"
      - "T-T-DS-001-002"
      - "T-I-DF-003-001"
  stride_codes:
    S: Spoofing
    T: Tampering
    R: Repudiation
    I: InformationDisclosure
    D: DenialOfService
    E: ElevationOfPrivilege
  fields:
    id:
      type: string
      required: true
    element_id:
      type: string
      required: true
      description: "DFD element ID (P-xxx, DS-xxx, DF-xxx, EI-xxx)"
    element_name:
      type: string
      required: true
    stride_type:
      type: string
      enum: [S, T, R, I, D, E]
      required: true
    stride_name:
      type: string
      required: true
    title:
      type: string
      required: true
    description:
      type: string
      required: true
    attack_scenario:
      type: string
    affected_flows:
      type: array
      items: string
    affected_stores:
      type: array
      items: string
    cwe:
      type: string
      pattern: "CWE-\\d+"
    capec:
      type: string
      pattern: "CAPEC-\\d+"
    initial_priority:
      type: string
      enum: [P0, P1, P2, P3]
    likelihood:
      type: string
      enum: [CRITICAL, HIGH, MEDIUM, LOW]
    impact:
      type: string
      enum: [CRITICAL, HIGH, MEDIUM, LOW]

# =============================================================================
# ValidatedRisk Entity (P6)
# =============================================================================
ValidatedRisk:
  description: "Verified exploitable risk after consolidation and validation"
  id:
    format: "VR-{Seq:03d}"
    examples:
      - "VR-001"
      - "VR-015"
  fields:
    id:
      type: string
      required: true
    title:
      type: string
      required: true
    # MANDATORY: Traceability
    threat_refs:
      type: array
      items: string
      description: "All source threat IDs (T-xxx)"
      required: true
      min_items: 1
    finding_refs:
      type: array
      items: string
      description: "Related finding IDs (F-xxx, GAP-xxx)"
    stride_types:
      type: array
      items: string
      enum: [S, T, R, I, D, E]
    priority:
      type: string
      enum: [P0, P1, P2, P3]
      required: true
    cvss_score:
      type: number
      minimum: 0.0
      maximum: 10.0
    cvss_vector:
      type: string
    location:
      type: object
      properties:
        files:
          type: array
          items: string
        elements:
          type: array
          items: string
        trust_boundary:
          type: string
    detailed_analysis:
      type: string
    root_cause:
      type: string
    related_cwe:
      type: string
      required: true
    related_capec:
      type: string
    related_attack:
      type: string
    related_poc:
      type: string
      description: "POC-xxx if available"
    validation:
      type: object
      properties:
        status:
          type: string
          enum: [verified, pending, theoretical, excluded]
          required: true
        poc_available:
          type: boolean
        test_cases:
          type: array
          items: string

# =============================================================================
# POC Entity (P6)
# =============================================================================
POC:
  description: "Proof of Concept for exploiting a validated risk"
  id:
    format: "POC-{Seq:03d}"
    examples:
      - "POC-001"
      - "POC-005"
  fields:
    poc_id:
      type: string
      required: true
    threat_ref:
      type: string
      description: "Primary threat ID"
      required: true
    stride_type:
      type: string
      enum: [S, T, R, I, D, E]
    verification_status:
      type: string
      enum: [verified, pending, theoretical, excluded]
      required: true
    exploitation_difficulty:
      type: string
      enum: [low, medium, high]
    prerequisites:
      type: array
      items: string
    vulnerability_location:
      type: object
      properties:
        file_path:
          type: string
        function_name:
          type: string
        line_number:
          type: integer
    vulnerable_code:
      type: string
    exploitation_steps:
      type: array
      items: string
    poc_code:
      type: string
      description: "Complete executable POC code"
    expected_result:
      type: string
    actual_result:
      type: string
    risk_assessment:
      type: object
      properties:
        complexity:
          type: string
          enum: [low, medium, high]
        attack_vector:
          type: string
        impact_scope:
          type: string
        data_sensitivity:
          type: string

# =============================================================================
# AttackPath Entity (P6)
# =============================================================================
AttackPath:
  id:
    format: "AP-{Seq:03d}"
    example: "AP-001"
  fields:
    path_id:
      type: string
      required: true
    path_name:
      type: string
      required: true
    entry_point:
      type: string
      required: true
    key_nodes:
      type: array
      items: string
    final_target:
      type: string
      required: true
    feasibility_score:
      type: number
      minimum: 0.0
      maximum: 10.0
    detection_difficulty:
      type: string
      enum: [low, medium, high]
    priority_fix:
      type: boolean
    related_risks:
      type: array
      items: string

# =============================================================================
# AttackChain Entity (P6)
# =============================================================================
AttackChain:
  id:
    format: "AC-{Seq:03d}"
    example: "AC-001"
  fields:
    chain_id:
      type: string
      required: true
    chain_name:
      type: string
      required: true
    entry_point:
      type: string
      required: true
    target:
      type: string
      required: true
    impact_scope:
      type: string
    difficulty:
      type: string
      enum: [low, medium, high]
    related_threats:
      type: array
      items: string
    steps:
      type: array
      items:
        type: object
        properties:
          step:
            type: integer
          title:
            type: string
          source:
            type: string
          target:
            type: string
          action:
            type: string
          code_location:
            type: string
          data_change:
            type: string
    attack_flow_diagram:
      type: string
      description: "ASCII box diagram"
    prerequisites:
      type: array
      items: string
    exploitation_commands:
      type: string
    ioc_indicators:
      type: array
      items: string
    defense_recommendations:
      type: array
      items:
        type: object
        properties:
          cutpoint:
            type: string
          recommendation:
            type: string

# =============================================================================
# Mitigation Entity (P7)
# =============================================================================
Mitigation:
  description: "Remediation measure for validated risks"
  id:
    format: "MIT-{Seq:03d}"
    examples:
      - "MIT-001"
      - "MIT-012"
    note: "Changed from M-xxx to MIT-xxx to avoid collision with Module entity"
  fields:
    id:
      type: string
      required: true
    title:
      type: string
      required: true
    risk_refs:
      type: array
      items: string
      description: "VR-xxx IDs this mitigation addresses"
      required: true
      min_items: 1
    threat_refs:
      type: array
      items: string
      description: "Original threat IDs"
    priority:
      type: string
      enum: [P0, P1, P2, P3]
      required: true
    effort:
      type: string
      enum: [LOW, MEDIUM, HIGH]
    implementation_time:
      type: string
    current_implementation:
      type: string
    recommended_fix:
      type: string
    implementation_steps:
      type: array
      items:
        type: object
        properties:
          step:
            type: integer
          action:
            type: string
          file:
            type: string
          code:
            type: string
          before:
            type: string
          after:
            type: string
    verification:
      type: object
      properties:
        test_cases:
          type: array
          items: string
        asvs_requirement:
          type: string
        wstg_test:
          type: string
    security_controls:
      type: array
      items:
        type: object
        properties:
          control:
            type: string
          domain:
            type: string
    additional_recommendations:
      type: array
      items: string

# =============================================================================
# Module Entity (P1)
# =============================================================================
Module:
  description: "Code module or component identified during project understanding"
  id:
    format: "M-{Seq:03d}"
    examples:
      - "M-001"
      - "M-015"
  fields:
    id:
      type: string
      required: true
    name:
      type: string
      required: true
    path:
      type: string
      description: "File path or directory path"
    type:
      type: string
      enum: [core, service, utility, config, test, external]
    description:
      type: string
    dependencies:
      type: array
      items: string
      description: "Other module IDs this depends on"
    entry_points:
      type: array
      items: string
      description: "Entry point IDs within this module"
    security_relevant:
      type: boolean
      description: "Whether module handles security-sensitive operations"

# =============================================================================
# SecurityGap Entity (P4)
# =============================================================================
SecurityGap:
  description: "Security design gap or deficiency identified in Phase 4"
  id:
    format: "GAP-{Seq:03d}"
    examples:
      - "GAP-001"
      - "GAP-010"
  fields:
    id:
      type: string
      required: true
    domain:
      type: string
      enum: [AUTHN, AUTHZ, INPUT, OUTPUT, CRYPTO, LOGGING, ERROR, API, DATA, CONFIG, INFRA, SUPPLY, AI, MOBILE, CLOUD, AGENTIC]
      required: true
    title:
      type: string
      required: true
    description:
      type: string
      required: true
    severity:
      type: string
      enum: [CRITICAL, HIGH, MEDIUM, LOW]
      required: true
    affected_modules:
      type: array
      items: string
      description: "Module IDs affected by this gap"
    missing_controls:
      type: array
      items: string
      description: "Expected security controls that are missing"
    recommendations:
      type: array
      items: string

# =============================================================================
# Interface Entity (P3)
# =============================================================================
Interface:
  description: "Cross-boundary interface point identified in trust boundary analysis"
  id:
    format: "IF-{Seq:03d}"
    examples:
      - "IF-001"
      - "IF-008"
  fields:
    id:
      type: string
      required: true
    name:
      type: string
      required: true
    type:
      type: string
      enum: [API, UI, CLI, IPC, Network, File, Database]
      required: true
    boundary_id:
      type: string
      description: "Trust boundary this interface crosses (TB-xxx)"
      required: true
    from_zone:
      type: string
      description: "Source trust zone"
    to_zone:
      type: string
      description: "Target trust zone"
    protocol:
      type: string
      examples: [HTTPS, gRPC, TCP, WebSocket, Internal]
    authentication:
      type: string
      enum: [none, basic, token, certificate, mTLS]
    data_classification:
      type: string
      enum: [public, internal, confidential, restricted]

# =============================================================================
# DataNode Entity (P3)
# =============================================================================
DataNode:
  description: "Sensitive data location or handling point in data flow"
  id:
    format: "DN-{Seq:03d}"
    examples:
      - "DN-001"
      - "DN-012"
  fields:
    id:
      type: string
      required: true
    name:
      type: string
      required: true
    data_type:
      type: string
      enum: [PII, credentials, financial, health, business, system, log]
      required: true
    location:
      type: object
      properties:
        element_id:
          type: string
          description: "DFD element ID (DS-xxx, P-xxx)"
        file_path:
          type: string
        storage_type:
          type: string
          enum: [memory, file, database, cache, session]
    sensitivity:
      type: string
      enum: [CRITICAL, HIGH, MEDIUM, LOW]
      required: true
    protection:
      type: object
      properties:
        encrypted:
          type: boolean
        masked:
          type: boolean
        access_controlled:
          type: boolean
    retention:
      type: string
      description: "Data retention policy"
    flows_to:
      type: array
      items: string
      description: "DataNode IDs this data flows to"

# =============================================================================
# Count Conservation Rule
# =============================================================================
CountConservation:
  description: "Formula ensuring all threats are accounted for in Phase 6"
  formula: "P5.threat_inventory.total = verified + theoretical + pending + excluded"
  validation:
    rule: |
      FOR each threat T in P5.threat_inventory:
        T MUST appear in exactly one VR.threat_refs[]
        OR T.status = 'excluded' with documented reason
  checkpoints:
    cp1: "P6.input_count = P5.threat_inventory.summary.total"
    cp2: "sum(verified, theoretical, pending, excluded) = input_count"
    cp3: "RISK-INVENTORY.count = P6.final_risk_count"
