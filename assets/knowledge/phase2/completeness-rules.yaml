# Completeness Validation Rules Knowledge Base
# Phase 2 DFD/CFD Analysis Enhancement
# Version: 1.1
# Source: Security Audit Standards + Threat Modeling Best Practices
# Purpose: Provide validation checklist for Phase 2 analysis completeness
#
# Changelog:
# - v1.1 (2026-01-26): Added data_flow_tracing_hints section with heuristic
#   guidance for Sub-phase 2.2 (Data Flow Tracing). Provides propagation and
#   transformation tracking patterns, taint analysis concepts, and implicit
#   data flow detection.
# - v1.0 (Initial): Core completeness validation rules

version: "1.1"
description: "Phase 2 完整性验证规则 - 确保分析覆盖全面"

# =============================================================================
# INTERFACE COMPLETENESS RULES
# =============================================================================
interface_completeness:
  description: "接口发现完整性验证"

  mandatory_checks:
    - id: "IC-001"
      rule: "每个路由定义文件都被分析"
      verification: "count(analyzed_route_files) == count(detected_route_files)"
      severity: "BLOCKING"
      remediation: "重新扫描未分析的路由文件"

    - id: "IC-002"
      rule: "每个 HTTP 端点都有对应的处理器"
      verification: "endpoints.all(e => e.handler != null)"
      severity: "BLOCKING"
      remediation: "追踪路由到处理函数的映射"

    - id: "IC-003"
      rule: "每个动态路由参数都有类型标注"
      verification: "path_params.all(p => p.type != 'unknown')"
      severity: "WARNING"
      remediation: "通过代码分析推断参数类型"

    - id: "IC-004"
      rule: "所有 HTTP 方法都被识别"
      verification: "endpoints.all(e => e.methods.length > 0)"
      severity: "BLOCKING"
      remediation: "检查路由定义中的 methods 参数"

  discovery_checklist:
    external_interfaces:
      - "REST API 端点 (/api/*, /v*/)"
      - "GraphQL 端点 (/graphql)"
      - "gRPC 服务定义 (*.proto)"
      - "WebSocket 端点 (/ws, /socket.io)"
      - "OAuth/SSO 回调 (/callback, /oauth/)"
      - "Webhook 接收器"
      - "文件上传端点"
      - "静态文件服务"

    internal_interfaces:
      - "服务间 RPC 调用"
      - "消息队列消费者"
      - "事件处理器"
      - "定时任务触发器"
      - "后台作业入口"

    hidden_interfaces:
      - "健康检查 (/health, /ready, /live)"
      - "文档端点 (/docs, /swagger, /openapi)"
      - "调试端点 (/debug, /_debug)"
      - "管理端点 (/admin, /actuator)"
      - "内部 API (/internal/*, /_*)"

  coverage_thresholds:
    minimum: 0.95  # 95% 接口发现率
    target: 0.99   # 99% 目标覆盖率

# =============================================================================
# DATA FLOW COMPLETENESS RULES
# =============================================================================
data_flow_completeness:
  description: "数据流追踪完整性验证"

  mandatory_checks:
    - id: "DF-001"
      rule: "每个 L1 接口都有完整的数据流追踪"
      verification: "L1_interfaces.all(i => i.has_complete_data_flow)"
      severity: "BLOCKING"
      remediation: "为缺失的接口添加数据流分析"

    - id: "DF-002"
      rule: "每个数据入口都有追踪到出口"
      verification: "entry_points.all(e => e.exit_points.length > 0)"
      severity: "BLOCKING"
      remediation: "追踪数据的完整生命周期"

    - id: "DF-003"
      rule: "敏感数据字段都被标记"
      verification: "sensitive_fields.all(f => f.classification != null)"
      severity: "WARNING"
      remediation: "使用敏感数据模式库识别"

    - id: "DF-004"
      rule: "数据变换节点都被识别"
      verification: "data_flows.all(f => f.transforms.length >= 0)"
      severity: "WARNING"
      remediation: "识别验证、加密、编码等变换"

  tracing_checklist:
    input_sources:
      - "HTTP 请求体 (JSON, Form, Multipart)"
      - "URL 参数 (Path, Query)"
      - "请求头 (Authorization, Cookie)"
      - "文件上传"
      - "WebSocket 消息"
      - "外部 API 响应"
      - "消息队列消息"
      - "数据库读取"

    output_sinks:
      - "HTTP 响应"
      - "数据库写入"
      - "文件存储"
      - "外部 API 调用"
      - "消息队列发送"
      - "日志输出"
      - "邮件/通知发送"

    transform_types:
      security_relevant:
        - "输入验证 (validation)"
        - "输入清洗 (sanitization)"
        - "密码哈希 (hashing)"
        - "数据加密 (encryption)"
        - "输出编码 (encoding)"
        - "数据脱敏 (masking)"
      business:
        - "格式转换"
        - "数据映射"
        - "聚合计算"
        - "业务规则处理"

  sensitive_data_flows:
    must_trace:
      - "密码从输入到存储"
      - "身份验证令牌生成和传输"
      - "PII 数据处理路径"
      - "支付信息处理路径"
      - "API 密钥/密钥的使用"

# =============================================================================
# CALL FLOW COMPLETENESS RULES
# =============================================================================
call_flow_completeness:
  description: "调用流分析完整性验证"

  mandatory_checks:
    - id: "CF-001"
      rule: "每个 L1 接口都有调用链"
      verification: "L1_interfaces.all(i => i.call_chain != null)"
      severity: "BLOCKING"
      remediation: "追踪从入口到出口的完整调用路径"

    - id: "CF-002"
      rule: "安全检查点都被识别"
      verification: "call_chains.all(c => c.security_checkpoints != null)"
      severity: "BLOCKING"
      remediation: "使用安全检查点模式库扫描"

    - id: "CF-003"
      rule: "异常处理路径都被追踪"
      verification: "call_chains.all(c => c.exception_paths != null)"
      severity: "WARNING"
      remediation: "识别 try-except/try-catch 块"

    - id: "CF-004"
      rule: "跨服务调用都被识别"
      verification: "service_calls.all(c => c.is_cross_service_marked)"
      severity: "WARNING"
      remediation: "标记 HTTP/gRPC/消息队列调用"

  analysis_checklist:
    call_chain_elements:
      - "入口函数 (Controller/Handler)"
      - "中间件/拦截器"
      - "业务服务层"
      - "数据访问层"
      - "外部服务调用"

    security_checkpoints:
      must_identify:
        - "认证检查 (Authentication)"
        - "授权检查 (Authorization)"
        - "输入验证 (Input Validation)"
        - "速率限制 (Rate Limiting)"
        - "CSRF 保护"
        - "日志审计"

    exception_handling:
      - "认证失败处理"
      - "授权失败处理"
      - "验证失败处理"
      - "业务异常处理"
      - "系统异常处理"

  security_coverage:
    authentication_coverage:
      rule: "受保护端点都有认证检查"
      threshold: 1.0  # 100%

    authorization_coverage:
      rule: "写操作都有授权检查"
      threshold: 1.0  # 100%

    validation_coverage:
      rule: "用户输入都有验证"
      threshold: 0.95  # 95%

# =============================================================================
# TRUST BOUNDARY COMPLETENESS RULES
# =============================================================================
trust_boundary_completeness:
  description: "信任边界标注完整性验证"

  mandatory_checks:
    - id: "TB-001"
      rule: "所有 L1 接口标记为 untrusted 入口"
      verification: "L1_interfaces.all(i => i.trust_level == 'untrusted')"
      severity: "BLOCKING"
      remediation: "标记外部入口为不可信"

    - id: "TB-002"
      rule: "数据库访问点标记为信任边界"
      verification: "data_stores.all(d => d.boundary_marked)"
      severity: "BLOCKING"
      remediation: "标记数据层边界"

    - id: "TB-003"
      rule: "跨服务调用标记为边界跨越"
      verification: "service_calls.all(c => c.boundary_crossing_marked)"
      severity: "WARNING"
      remediation: "标记服务间通信边界"

    - id: "TB-004"
      rule: "每个信任边界都有保护措施"
      verification: "trust_boundaries.all(b => b.protection != null)"
      severity: "WARNING"
      remediation: "识别边界处的安全控制"

  boundary_types:
    external_to_internal:
      description: "外部请求进入系统"
      expected_protection:
        - "认证"
        - "输入验证"
        - "速率限制"

    internal_to_data:
      description: "应用访问数据存储"
      expected_protection:
        - "参数化查询"
        - "最小权限原则"
        - "连接加密"

    service_to_service:
      description: "服务间通信"
      expected_protection:
        - "服务认证"
        - "传输加密"
        - "请求签名"

    internal_to_external:
      description: "系统调用外部服务"
      expected_protection:
        - "TLS 验证"
        - "超时设置"
        - "重试策略"

# =============================================================================
# DFD-CFD CROSS VALIDATION RULES
# =============================================================================
cross_validation:
  description: "DFD 与 CFD 交叉验证规则"

  mandatory_checks:
    - id: "XV-001"
      rule: "每个数据流都有对应的调用流"
      verification: "data_flows.all(df => call_flows.exists(cf => cf.covers(df)))"
      severity: "WARNING"
      remediation: "补充缺失的调用流分析"

    - id: "XV-002"
      rule: "DFD 敏感节点在 CFD 中有安全检查"
      verification: "sensitive_nodes.all(n => n.has_security_check_in_cfd)"
      severity: "BLOCKING"
      remediation: "验证敏感数据处理是否有保护"

    - id: "XV-003"
      rule: "CFD 安全检查点在 DFD 中有对应数据流"
      verification: "security_checkpoints.all(c => c.protects_data_flow)"
      severity: "WARNING"
      remediation: "确认安全控制确实保护了数据"

  correlation_checks:
    - check: "认证检查覆盖身份数据流"
      dfd_element: "identity_data_flow"
      cfd_requirement: "authentication_checkpoint"

    - check: "授权检查覆盖权限数据流"
      dfd_element: "permission_data_flow"
      cfd_requirement: "authorization_checkpoint"

    - check: "验证检查覆盖用户输入流"
      dfd_element: "user_input_flow"
      cfd_requirement: "validation_checkpoint"

    - check: "加密覆盖敏感数据流"
      dfd_element: "sensitive_data_flow"
      cfd_requirement: "encryption_checkpoint"

# =============================================================================
# DATA STORE COMPLETENESS RULES
# =============================================================================
data_store_completeness:
  description: "数据存储发现完整性验证"

  mandatory_checks:
    - id: "DS-001"
      rule: "每个数据存储都有访问路径"
      verification: "data_stores.all(d => d.access_paths.length > 0)"
      severity: "BLOCKING"
      remediation: "追踪数据存储的访问模式"

    - id: "DS-002"
      rule: "敏感数据存储都被标记"
      verification: "sensitive_stores.all(s => s.classification != null)"
      severity: "BLOCKING"
      remediation: "识别存储敏感数据的表/集合"

    - id: "DS-003"
      rule: "每个数据存储都有安全配置分析"
      verification: "data_stores.all(d => d.security_config != null)"
      severity: "WARNING"
      remediation: "分析加密、备份、访问控制配置"

  discovery_checklist:
    - "主数据库 (PostgreSQL, MySQL, MongoDB)"
    - "缓存系统 (Redis, Memcached)"
    - "文件存储 (S3, 本地文件系统)"
    - "消息队列 (RabbitMQ, Kafka)"
    - "搜索引擎 (Elasticsearch)"
    - "会话存储"
    - "日志存储"
    - "备份存储"

# =============================================================================
# INPUT MODALITY COMPLETENESS
# =============================================================================
input_modality_completeness:
  description: "输入模态覆盖完整性"

  mandatory_checks:
    - id: "IM-001"
      rule: "每个接口的所有输入类型都被识别"
      verification: "interfaces.all(i => i.input_modalities.complete)"
      severity: "WARNING"
      remediation: "分析函数签名识别所有输入类型"

  modality_types:
    - "路径参数 (path_params)"
    - "查询参数 (query_params)"
    - "请求体 (json_body, form_data, xml_body)"
    - "文件上传 (multipart)"
    - "请求头 (headers)"
    - "Cookie"
    - "WebSocket 消息"

  per_modality_checks:
    path_params:
      - "参数类型是否正确"
      - "是否有验证规则"
    query_params:
      - "是否有默认值"
      - "是否有验证规则"
    request_body:
      - "是否有 schema 定义"
      - "必填字段是否标记"
    file_upload:
      - "文件类型限制"
      - "文件大小限制"
    headers:
      - "必需 header 是否标记"
      - "安全相关 header 是否识别"

# =============================================================================
# QUALITY GATES
# =============================================================================
quality_gates:
  description: "Phase 2 质量门控阈值"

  pass_criteria:
    interface_coverage:
      minimum: 0.95
      description: "接口发现覆盖率"

    data_flow_coverage:
      minimum: 1.0
      description: "L1 接口数据流追踪覆盖率"

    call_flow_coverage:
      minimum: 1.0
      description: "L1 接口调用流覆盖率"

    security_checkpoint_identification:
      minimum: 0.90
      description: "安全检查点识别率"

    sensitive_data_marking:
      minimum: 0.90
      description: "敏感数据标记率"

    trust_boundary_coverage:
      minimum: 1.0
      description: "信任边界标注覆盖率"

    dfd_cfd_consistency:
      minimum: 0.95
      description: "DFD-CFD 一致性"

  blocking_failures:
    - "接口覆盖率 < 90%"
    - "L1 接口无数据流追踪"
    - "L1 接口无调用流"
    - "信任边界未标注"
    - "敏感数据处理无安全检查"

  warning_conditions:
    - "接口覆盖率 90-95%"
    - "安全检查点覆盖 < 90%"
    - "敏感数据标记 < 90%"
    - "DFD-CFD 不一致项存在"

# =============================================================================
# HEURISTIC VALIDATION HINTS
# =============================================================================
heuristic_hints:
  common_gaps:
    interface_gaps:
      - "版本化 API 的旧版本 (/v1/* 发现了但 /v0/* 遗漏)"
      - "内部调试接口 (/_debug, /actuator)"
      - "动态注册的路由"
      - "WebSocket 升级端点"

    data_flow_gaps:
      - "错误响应中的敏感数据泄露"
      - "日志中的敏感数据"
      - "缓存中的敏感数据"
      - "外部 API 调用中的数据"

    call_flow_gaps:
      - "异步处理中的安全检查"
      - "定时任务的权限检查"
      - "事件处理器的认证"
      - "回调函数的验证"

    trust_boundary_gaps:
      - "内部服务间的隐式信任"
      - "第三方 SDK 的边界"
      - "插件/扩展的边界"

  validation_sequence:
    - "1. 验证所有路由文件已分析"
    - "2. 验证 L1 接口完整性"
    - "3. 验证数据流追踪完整"
    - "4. 验证调用流覆盖"
    - "5. 验证安全检查点识别"
    - "6. 验证信任边界标注"
    - "7. 执行 DFD-CFD 交叉验证"
    - "8. 生成验证报告"

  remediation_priority:
    critical:
      - "未覆盖的 L1 接口"
      - "敏感数据流无保护"
      - "认证/授权缺失"
    high:
      - "安全检查点覆盖不足"
      - "敏感数据未标记"
    medium:
      - "DFD-CFD 不一致"
      - "输入模态覆盖不全"
    low:
      - "内部接口覆盖不全"
      - "非安全相关的元数据缺失"

# =============================================================================
# DATA FLOW TRACING HINTS (Sub-phase 2.2)
# =============================================================================
# Purpose: Heuristic guidance for LLM to trace data propagation and
#          transformations. LLM naturally understands code semantics;
#          these hints help identify security-relevant flow patterns.
# Note: This is NOT a deterministic script - it's guidance for Claude's
#       semantic understanding during code review.

data_flow_tracing_hints:
  description: "数据流追踪启发式提示 - 帮助识别数据传播和变换"

  # ---------------------------------------------------------------------------
  # PROPAGATION PATTERNS
  # ---------------------------------------------------------------------------
  propagation_patterns:
    description: "数据如何从一个位置传播到另一个位置"

    direct_assignment:
      description: "直接赋值传播"
      examples:
        - "user_input = request.data"
        - "result = process(input)"
        - "output = transform(data)"
      trace_hint: "追踪变量赋值链，识别数据来源"

    function_parameter:
      description: "函数参数传递"
      examples:
        - "def process(user_data): ..."
        - "service.handle(request)"
        - "await fetch(url, body=data)"
      trace_hint: "追踪函数调用，识别数据如何通过参数传递"

    return_value:
      description: "函数返回值"
      examples:
        - "result = validate(input)"
        - "user = await get_user(token)"
      trace_hint: "追踪返回值如何被后续代码使用"

    container_spread:
      description: "容器数据展开"
      examples:
        - "{**request.data}"
        - "[...items, new_item]"
        - "Object.assign({}, data)"
      trace_hint: "注意对象/数组展开可能传播敏感字段"

    attribute_access:
      description: "属性访问"
      examples:
        - "user.password"
        - "request.headers['Authorization']"
        - "data['api_key']"
      trace_hint: "追踪对象属性访问，特别是敏感字段"

  # ---------------------------------------------------------------------------
  # TRANSFORMATION PATTERNS
  # ---------------------------------------------------------------------------
  transformation_patterns:
    description: "数据如何被变换（安全相关变换需特别关注）"

    security_transformations:
      description: "安全相关的数据变换"
      patterns:
        hashing:
          indicators: ["hash", "bcrypt", "argon2", "pbkdf2", "sha256"]
          purpose: "密码/敏感数据的单向变换"
          security_note: "验证是否使用安全算法和盐值"

        encryption:
          indicators: ["encrypt", "cipher", "aes", "rsa", "fernet"]
          purpose: "可逆加密保护"
          security_note: "追踪密钥管理和解密位置"

        encoding:
          indicators: ["encode", "base64", "url_encode", "html_escape"]
          purpose: "格式转换"
          security_note: "编码不是加密，仍可能泄露"

        sanitization:
          indicators: ["sanitize", "clean", "strip", "escape", "purify"]
          purpose: "移除/转义危险内容"
          security_note: "验证在使用前完成清洗"

        validation:
          indicators: ["validate", "check", "verify", "is_valid"]
          purpose: "验证数据符合预期"
          security_note: "验证失败后数据不应继续流动"

        masking:
          indicators: ["mask", "redact", "obfuscate", "anonymize"]
          purpose: "隐藏敏感信息"
          security_note: "验证遮蔽后信息不可恢复"

    business_transformations:
      description: "业务相关的数据变换"
      patterns:
        - "格式转换 (JSON → XML, protobuf)"
        - "数据映射 (DTO → Entity)"
        - "聚合计算 (sum, avg, count)"
        - "序列化/反序列化"
        - "压缩/解压"

  # ---------------------------------------------------------------------------
  # TAINT TRACKING CONCEPTS
  # ---------------------------------------------------------------------------
  taint_tracking:
    description: "污点追踪概念 - 帮助理解数据信任级别变化"

    taint_sources:
      description: "污点来源 (不可信数据入口)"
      categories:
        user_input:
          - "request.body"
          - "request.params"
          - "request.query"
          - "request.headers"
          - "request.cookies"
          - "websocket.message"
        external_data:
          - "api_response"
          - "file_content"
          - "database_result (from user-provided query)"
          - "message_queue_payload"
        environment:
          - "environment variables (if user-controllable)"
          - "config (if from external source)"

    taint_sinks:
      description: "污点汇聚点 (敏感操作)"
      categories:
        code_execution:
          patterns: ["dynamic code evaluation", "shell command execution"]
          security_risk: "代码注入"
        database:
          patterns: ["raw SQL queries", "ORM with raw expressions"]
          security_risk: "SQL 注入"
        file_system:
          patterns: ["file open with path", "file read/write operations"]
          security_risk: "路径遍历"
        network:
          patterns: ["HTTP requests with user URL", "fetch operations"]
          security_risk: "SSRF"
        output:
          patterns: ["response rendering", "logging statements"]
          security_risk: "XSS/信息泄露"

    sanitizers:
      description: "清洗器 (降低或移除污点)"
      examples:
        - "parameterized query (SQL)"
        - "html_escape (XSS)"
        - "path validation (path traversal)"
        - "URL validation (SSRF)"
        - "schema validation (general)"
      trace_hint: "验证清洗器在污点源和汇聚点之间"

  # ---------------------------------------------------------------------------
  # IMPLICIT DATA FLOWS
  # ---------------------------------------------------------------------------
  implicit_flows:
    description: "隐式数据流 - 不通过直接赋值的数据传播"

    patterns:
      control_flow_based:
        description: "基于控制流的隐式传播"
        example: |
          if is_admin(user):  # user.role 隐式传播到后续逻辑
              perform_admin_action()
        trace_hint: "条件判断可能泄露数据属性信息"

      timing_based:
        description: "基于时间的隐式传播"
        example: "密码比较时间可能泄露信息"
        trace_hint: "密码比较应使用常量时间比较"

      error_based:
        description: "基于错误的隐式传播"
        example: "错误消息区分 '用户不存在' 和 '密码错误'"
        trace_hint: "错误消息可能泄露内部状态"

      logging_based:
        description: "日志中的隐式传播"
        example: "日志记录用户名或请求参数"
        trace_hint: "日志可能包含敏感数据"

  # ---------------------------------------------------------------------------
  # AI/LLM SPECIFIC DATA FLOWS
  # ---------------------------------------------------------------------------
  ai_llm_data_flows:
    description: "AI/LLM 应用特有的数据流模式"

    prompt_data_flow:
      description: "用户输入如何流入 prompt"
      patterns:
        - "user_message → prompt_template → llm_call"
        - "context_documents → system_prompt"
        - "chat_history → conversation_context"
      trace_hint: "追踪用户输入如何被嵌入 prompt"

    rag_data_flow:
      description: "RAG 检索数据流"
      patterns:
        - "query → embedding → vector_search → documents"
        - "documents → context_window → llm_response"
      trace_hint: "追踪检索结果如何进入 LLM 上下文"

    tool_data_flow:
      description: "工具调用数据流"
      patterns:
        - "llm_output → tool_args → tool_execution → llm_input"
        - "function_result → llm_context"
      trace_hint: "追踪 LLM 输出如何触发工具调用"

    agent_data_flow:
      description: "Agent 间数据流"
      patterns:
        - "agent_a.output → agent_b.input"
        - "shared_memory → multiple_agents"
        - "supervisor_feedback → worker_agent"
      trace_hint: "追踪 Agent 间通信和共享状态"

  # ---------------------------------------------------------------------------
  # TRACING STRATEGY
  # ---------------------------------------------------------------------------
  tracing_strategy:
    description: "数据流追踪策略建议"

    approach:
      - step: "1. 识别入口点"
        action: "从 interface_inventory 的 L1 接口开始"

      - step: "2. 识别敏感数据"
        action: "标记 PII、凭证、密钥等敏感字段"

      - step: "3. 前向追踪"
        action: "从入口追踪数据到所有使用点"

      - step: "4. 标记变换"
        action: "识别数据经过的安全变换"

      - step: "5. 识别汇聚点"
        action: "标记数据最终存储/输出位置"

      - step: "6. 验证保护"
        action: "确认敏感数据在汇聚点前有适当保护"

    priority_order:
      - "认证凭证流 (密码、令牌)"
      - "PII 数据流 (姓名、邮箱、身份证)"
      - "财务数据流 (支付、账户)"
      - "API 密钥/密钥流"
      - "一般用户输入"

  # ---------------------------------------------------------------------------
  # COMMON PITFALLS
  # ---------------------------------------------------------------------------
  common_pitfalls:
    description: "常见遗漏的数据流"

    categories:
      - pitfall: "错误响应中的敏感数据"
        example: "错误消息包含用户邮箱"
        check: "审查所有错误处理路径"

      - pitfall: "日志中的敏感数据"
        example: "调试日志包含请求内容"
        check: "审查日志语句"

      - pitfall: "缓存中的敏感数据"
        example: "用户数据直接缓存"
        check: "审查缓存操作"

      - pitfall: "临时变量中的敏感数据"
        example: "解密后的密码存储在变量中"
        check: "审查密码/密钥处理"

      - pitfall: "序列化时的数据泄露"
        example: "对象整体序列化包含敏感字段"
        check: "审查序列化操作"

      - pitfall: "调试代码中的数据泄露"
        example: "调试输出包含密钥"
        check: "审查调试代码"
